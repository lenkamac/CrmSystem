{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}

    {% block css %}
    	<link rel="stylesheet" href="{% static 'dashboard/dashboard.css' %}">
    {% endblock %}

    {% include 'core/partials/offcanvas_menu.html' %}

    <!-- Page Content -->
    <div class="container vh-100 w-100 my-lg-4">

        <div class="row mx-lg-5 justify-content-center">
            <div class="col-lg-10">
                <div class="text-center">
                    <h1 class="px-5 py-lg-3">Welcome to the dashboard "<span style="color: #0f5132;">{{ user.username }}</span>"</h1>
                </div>
            </div>
            <div class="col-lg-2">
                <div class="text-center mt-3">
                    <div id="dashboard-datetime" class="text-start fw-semibold" style="font-size: 1.1rem;"></div>
                </div>
            </div>
        </div>

        <div class="row mt-4 justify-content-center">
            <div class="col-md-3">
                <div class="card mt-4 mx-3">
                    <div class="card-body">
                        <h5 class="card-title text-center fs-4"><i class="fa fa-users px-2"></i>Leads</h5>
                        <p class="card-text display-6 text-center">{{ lead_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <h4 class="text-start">Latest Leads</h4>
                <table class="table table-striped">
                    <tr class="thead-lead">
                        <th>Date</th>
                        <th>Name</th>
                        <th>Company</th>
                        <th>Email</th>
                        <th>Priority</th>
                    </tr>
                    {% for lead in latest_leads %}
                        <tr>
                            <td class="text-start">{{ lead.created_at }}</td>
                            <td class="text-start"><a href="{% url 'lead:detail' lead.pk %}">{{ lead.last_name }}, {{ lead.first_name }}</a></td> <!-- or use the field(s) you prefer -->
                            <td class="text-start">{{ lead.company }}</td>
                            <td class="text-start">{{ lead.email }}</td>
                            <td class="text-start">{{ lead.priority }}</td>
                        </tr>
                    {% empty %}
                        <li class="list-group-item">No leads found.</li>
                    {% endfor %}
                </table>
            </div>

        </div>


        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card mt-4 mx-3">
                    <div class="card-body">
                        <h3 class="card-title text-center fs-4"><i class="fa fa-users px-2"></i>Clients</h3>
                        <p class="card-text display-6 text-center">{{ client_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <h4>Latest Clients</h4>
                <table class="table table-striped">
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Company</th>
                        <th>Email</th>
                    </tr>
                    {% for client in latest_clients %}
                        <tr>
                            <td class="text-start">{{ client.created_at }}</td>
                            <td class="text-start"><a href="{% url 'client:detail' client.pk %}">{{ client.last_name }}, {{ client.first_name }}</a></td> <!-- or use the field(s) you prefer -->
                            <td class="text-start">{{ client.company }}</td>
                            <td class="text-start">{{ client.email }}</td>
                        </tr>
                    {% empty %}
                        <li class="list-group-item">No clients found.</li>
                    {% endfor %}
                </table>
            </div>
        </div>

        <!-- Interactive Clients and Leads Graph -->
        <div class="row mt-4 justify-content-center">
            <div class="col-12">

                <!-- Time Period Filter -->
                <div class="row mb-3">
                    <div class="col-md-6 bg-danger">
                        <h4 class="mb-0">Leads & Clients Over Time</h4>
                    </div>
                    <div class="col-md-3">
                        <!-- Chart Type Selector -->
                        <div class="d-flex align-items-center">
                            <label for="chartType" class="me-2 fw-semibold text-nowrap">Chart Type:</label>
                            <select id="chartType" class="form-select form-select-sm" style="width: auto;">
                                <option value="line">Line Chart</option>
                                <option value="bar">Bar Chart</option>
                                <option value="area">Area Chart</option>
                                <option value="mixed">Mixed Chart</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <form method="get" id="periodFilterForm" class="d-flex justify-content-end align-items-center">
                            <label for="period" class="me-2 fw-semibold">Time Period:</label>
                            <select name="period" id="period" class="form-select form-select-sm" style="width: auto;">
                                <option value="all" {% if selected_period == 'all' %}selected{% endif %}>All Time</option>
                                <option value="7days" {% if selected_period == '7days' %}selected{% endif %}>Last 7 Days</option>
                                <option value="30days" {% if selected_period == '30days' %}selected{% endif %}>Last 30 Days</option>
                                <option value="90days" {% if selected_period == '90days' %}selected{% endif %}>Last 90 Days</option>
                                <option value="6months" {% if selected_period == '6months' %}selected{% endif %}>Last 6 Months</option>
                                <option value="1year" {% if selected_period == '1year' %}selected{% endif %}>Last Year</option>
                            </select>
                        </form>
                    </div>
                </div>

                <!-- Chart.js Canvas -->
                <div style="position: relative; height: 400px;">
                    <canvas id="leadsChart"></canvas>
                </div>

            </div>
        </div>

    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Dashboard Chart Script -->
    <script src="{% static 'dashboard/js/chart.js' %}"></script>
    <script>
        function updateDateTime() {
            const now = new Date();
            // Format: e.g. Thursday, 2025-09-18 14:05:03
            const options = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' };
            const datePart = now.toLocaleDateString(undefined, options);
            const timePart = now.toLocaleTimeString(undefined, { hour12: false });
            document.getElementById('dashboard-datetime').textContent = datePart + ' ' + timePart;
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);
    </script>
    <!-- Initialize Dashboard -->
    <script>
        // Initialize dashboard with chart data
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard({
                dates: {{ chart_dates|safe }},
                leadCounts: {{ lead_counts|safe }},
                clientCounts: {{ client_counts|safe }}
            });
        });
    </script>



{% endblock %}